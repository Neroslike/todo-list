/* 1.- If a todo's is a parent, they get added to the pending tasks when created
   2.- Sort the pending tasks array by priority, and sort the children array by priority as well */

import helper from "./helper";
import ProjectComponent from "./components/ProjectComponent";
import Todo from "./todo";
import Neros from "./Neros";
import { Storage } from "./storageManagement";
class Project {
  #pendingTasks;
  #completedTasks;

  static projects = [];

  static selected;

  constructor(name, firstLoad = false) {
    this.name = name;
    this.component = new ProjectComponent(name, { project: this });
    this.#pendingTasks = [];
    this.#completedTasks = [];
    this.firstLoad = firstLoad;
    Project.projects.push(this);
    if (!this.firstLoad) {
      Storage.saveData();
    } else {
      this.firstLoad = false;
    }
  }

  get pending() {
    return [...this.#pendingTasks];
  }

  get completed() {
    return [...this.#completedTasks];
  }

  addPending(item) {
    this.#pendingTasks.push(item);
  }

  addCompleted(item) {
    this.#completedTasks.push(item);
  }

  completeTodo(todo) {
    let foundIndex = this.#pendingTasks.indexOf(todo);
    this.#pendingTasks.splice(foundIndex, 1);
    this.addCompleted(todo);
  }

  resumeTodo(todo) {
    let foundIndex = this.#completedTasks.indexOf(todo);
    this.#completedTasks.splice(foundIndex, 1);
    this.addPending(todo);
  }

  clearCompletedTodos() {
    this.#completedTasks = [];
  }

  deleteTodo(task) {
    if (this.#pendingTasks.includes(task)) {
      let taskIndex = this.#pendingTasks.indexOf(task);
      taskIndex === 0
        ? this.#pendingTasks.shift()
        : this.#pendingTasks.splice(taskIndex, taskIndex);
    } else {
      let taskIndex = this.#completedTasks.indexOf(task);
      taskIndex === 0
        ? this.#completedTasks.shift()
        : this.#completedTasks.splice(taskIndex, taskIndex);
    }
  }

  toJSON() {
    let obj = {
      name: this.name,
      pending: {},
      completed: {},
    };
    this.#pendingTasks.forEach((task, index) => {
      obj.pending[`task${index}`] = task.toJSON();
    });
    this.#completedTasks.forEach((task, index) => {
      obj.completed[`task${index}`] = task.toJSON();
    });
    return JSON.stringify(obj);
  }

  static fromJSON(json) {
    let projectOBJ = JSON.parse(json);
    for (const key in projectOBJ.pending) {
      if (Object.hasOwnProperty.call(projectOBJ.pending, key)) {
        projectOBJ.pending[key] = Todo.fromJSON(projectOBJ.pending[key]);
      }
    }
    for (const key in projectOBJ.completed) {
      if (Object.hasOwnProperty.call(projectOBJ.completed, key)) {
        projectOBJ.completed[key] = Todo.fromJSON(projectOBJ.completed[key]);
      }
    }
    return projectOBJ;
  }

  static loadProject(obj) {
    let project = new Project(obj.name, true);
    Project.selected = project;
    for (const key in obj.pending) {
      if (Object.hasOwnProperty.call(obj.pending, key)) {
        Todo.loadTodo(obj.pending[key]);
      }
    }
    for (const key in obj.completed) {
      if (Object.hasOwnProperty.call(obj.completed, key)) {
        Todo.loadTodo(obj.completed[key]);
      }
    }
    Neros.projects.registerComponent(project.component);
  }

  static deleteProject(project) {
    let foundIndex = Project.projects.indexOf(project);
    Project.projects.splice(foundIndex, 1);
    Storage.saveData();
  }
}

export default Project;
